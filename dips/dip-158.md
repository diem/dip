---
dip: 158
title: Off-chain API Version 2 Extensions - Charge and Auth/Capture (eCommerce P2M Payments)
authors: Daniel Prinz, Yinon Zohar, Kevin Hurley (@kphfb)
status: Draft
type: Standard
created: 03/15/2021
---

# Summary
---
An extension of the Off-Chain protocol for enabling eCommerce P2M payments (Peer 2 Merchant) of two types:
* Charge
* Auth & Capture

---
# Abstract / Motivation
---

Versions 1/2 of the Off-Chain Protocol are described in [DIP 1](https://dip.diem.com/dip-1/). 

Version 3 as described here is an extension of the Off-Chain Protocol and adds features to support more advanced functionality - particularly targeted to support merchant use-cases. 

This DIP is aimed to support a scenario of paying with a Diem wallet to a merchant in an app or an eCommerce website. 
There are some key differences in the process of paying a merchant (P2M) that differ than simple P2P transfer:
1. Buyer details are required for **every** payment / purchase in order to perform risk checks and apply AML policies
2. The merchant requires a way to correlate the funds transfer to a payment or payment request for reconciliation processes
3. The merchant "drives" the process and controls the type of payment and its timing. For example, the merchant will decide when to capture the funds and whether to capture the entire amount or only partial amount based on the supplied service / products. 

The high level flow of a eCommerce P2M payment is:
1. On the merchant's checkout page the user chooses to pay with Diem and selects the preferred Diem wallet to use
2. The merchant's VASP genereates a payment request with all details needed to identify this payment later in the process
3. The user's VASP (i.e. wallet) parses the payment request (e.g. by scanning the payment request QR) and then present the request for the user to approve
4. The user approves the payment request in the wallet (user's VASP)
5. The wallet triggers the off-chain negotiations which will end (if successful) with the funds being authorized or captured (depending on the payment type)
    1. For a payment of type **charge** successful off-chain negotiations will result in funds being captured. The user wallet is expected to submit an on-chain transaction to finalize the payment
    2. For a payment of type **auth/capture** successful off-chain negotiations will result in funds being authorized, i.e. locked so they can later be captured. The user wallet will submit an on-chain transaction to finalize the payment only after a capture request from the merchant's VASP

This DIP defines the type of eCommerce P2M payments, corresponsing requests and the payment structures, including the fields that should be supplied to the user wallet application using a link or a QR object. 

---
# Disclaimer
---

This DIP does not contain the phase of exchanging identifiers between VASPs that is required to negotiate merchant scenarios.

For the purpose of this document, we will assume that given a payment object with two VASP addresses and some underline indetifier, there is a protocol for exchaning these identities under VASPs (buyer and merchant) without revealing their identities to the public. 

The process described below starts at the phase that both sides have the relevant payment unique identifier (reference) and each VASP knows to corrlate it to its respectful entity under. 

---
# Synonyms
---

For the sake of simplicity, we use the following terms:
* "Buyer VASP", "User VASP" or "Wallet" - The VASP representing the customer/buyer. This is the VASP that will send the funds and eventually will submit the payment transaction to the blockchain in order to pay the merchant
* "Merchant" - The VASP representing the merchant which recieves the funds (transaction)
* "Buyer", "Customer" or "User" - The person who whishes to pay to the merchant for goods or services

---
# Specification
---

### *VERSION SUPPORT: Supported only in version 3 of off-chain APIs*

## Payment request fields

The following fields should be used to define a payment request. These fields should be encoded into a series of URL parameters appended to the query string. In case of QR code, the image should include the full link with all parameters. 

| Field                  | Type    | Required?  | Description                                    |
|------------------------|---------|------------|------------------------------------------------|
| vasp_address               | str      | Y          | Address of account from which billing will happen. The address is encoded using bech32 and should uniquly identify the merchant. For Diem addresses format, refer to the "account identifiers" section in [DIP-5](https://dip.diem.com/dip-5/#account-identifiers). |
| reference_id           | str     | Y          | A unique identifier of this payment. Should be a UUID according to RFC4122 with "-"'s included. |
| merchant_name              | str      | Y          | The name of the biller |
| description                | str      | N          | Description of the funds pull pre-approval. May be utilized to show the user description about the request for funds pull pre-approval |
| checkout_data_type         | str      | Y          | The fixed string `PAYMENT_REQUEST` |
| action                     | str enum | Y          | One of: `CHARGE` or `AUTHORIZATION` |
| expiration_timestamp       | uint     | N          | Unix timestamp indicating the time at which this pre-approval will expire - after which no funds pull can occur.  To expire an existing pre-approval early, this field can be updated with the current Unix timestamp. |
| currency                   | str enum | N          | One of the supported on-chain currency types - ex. `XDX`, etc. |
| reset_period_unit          | str enum | N          | One of: `day`, `week`, `month`, `year`. This unit should be treated as a sliding time window. E.g., one week would be summary of the past 7 days transactions, no matter what weekday it is. This field is mandatory in case `reset_period_value` and `amount_per_period` are set. |
| reset_period_value         | uint     | N          | Number of "reset_period_unit"(s). This field is mandatory in case `reset_period_unit` and `amount_per_period` are set. |
| amount_per_period          | uint     | N          | Max amount that is approved for a single period of time. This is the sum across all transactions that occur in the period. Base units are the same as for on-chain transactions for this currency. For example, if DiemUSD is represented on-chain where “1” equals 1e-6 dollars, then “1” equals the same amount here.  For any currency, the on-chain mapping must be used for amounts. This field is mandatory in case `reset_period_unit` and `reset_period_value` are set. |
| max_transaction_amount     | uint     | N          | Max transaction amount that is approved for funds pull pre-approval.  This is the maximum amount that may occur in a single transaction while utilizing this funds pull pre-approval. Base units are the same as for on-chain transactions for this currency. For example, if DiemUSD is represented on-chain where “1” equals 1e-6 dollars, then “1” equals the same amount here.  For any currency, the on-chain mapping must be used for amounts. |
| redirect_url               | str      | Y          | The URL to redirect the user after the process is completed (either for success or failure of the process). Note that the user will be redirected to this URL using `GET` HTTP method.  |

E.g., for the following parameters: 

| Field                      | Value                                                                             |
|----------------------------|-----------------------------------------------------------------------------------|
| vasp_address               | dm1pllhdmn9m42vcsamx24zrxgs3qqqpzg3ng32kvacapx5fl                                 | 
| reference_id               | ad8d888a-1791-4b63-98e5-6f1d6ddb4411                                              |
| merchant_name              | Kevin's online shop                                                               |
| description                | Diem T-Shirt                                                                      |
| checkout_data_type         | PAYMENT_REQUEST                                                                   |
| action                     | CHARGE                                                                            |
| amount                     | 1000000000                                                                        |
| currency                   | XUS                                                                               |
| expiration_timestamp       | 1615872312                                                                        |
| redirect_url               | https://merchant.com/order/164f040b-ee4d-411e-8016-418c46f1920b/checkout/complete |

The URL format would be (the domain and path are examples - the real wallet domain/path should be used):

`https://some-diem-wallet.com/pay?vasp_address=dm1pllhdmn9m42vcsamx24zrxgs3qqqpzg3ng32kvacapx5fl&reference_id=ad8d888a-1791-4b63-98e5-6f1d6ddb4411&merchant_name=Kevin%27s%20online%20shop&description=Diem%20T-Shirt&checkout_data_type=PAYMENT_REQUEST&action=CHARGE&amount=1000000000&currency=XUS&expiration_timestamp=1615872312&redirectUrl=https%3A%2F%2Fmerchant.com%2Forder%2F164f040b-ee4d-411e-8016-418c46f1920b%2Fcheckout%2Fcomplete`



After parsing this request, the buyer VASP can use out-of-band methods to determine if this request should be granted. E.g., asking the user to approve this request while presenting the scope of it. 

The buyer VASP may ask for further details of the merchant using off-chain commands referring to the `reference_id` field. 

## Request/Response Payload
All requests between VASPs are structured as [`CommandRequestObject`s](https://dip.diem.com/dip-1/#commandrequestobject) and all responses are structured as [`CommandResponseObject`s](https://dip.diem.com/dip-1/#commandresponseobject). 

For a **charge** command, the resulting command that the sender should start with takes a form of the following:

```
{
      "_ObjectType": "CommandRequestObject"
      "command_type": "ChargeCommand",
      "cid": "3185027f-0574-6f55-2668-3a38fdb5de98",
      "command": {
        "_ObjectType": "ChargeCommand",
        "payment": {
          "reference_id": "4185027f-0574-6f55-2668-3a38fdb5de98",
          "sender": {
            "address": "dm1pg9q5zs2pg9q5zs2pg9q5zs2pg9skzctpv9skzcg9kmwta",
            "kyc_data": {
              "payload_version": 1,
              "type": "individual",
              "given_name": "ben",
              "surname": "maurer",
              "address": {
                "city": "Sunnyvale",
                "country": "US",
                "line1": "1234 Maple Street",
                "line2": "Apartment 123",
                "postal_code": "12345",
                "state": "California",
              },
              "dob": "1920-03-20",
              "place_of_birth": {
                "city": "Sunnyvale",
                "country": "US",
                "postal_code": "12345",
                "state": "California",
              }
            },
            "status": {
              "status": "needs_kyb_data"
            },
          },
          "receiver": {
            "address": "dm1pllhdmn9m42vcsamx24zrxgs3qqqpzg3ng32kvacapx5fl",
          },
          "action": {
            "amount": 1000000000000,
            "currency": "XUS",
            "action": "charge",
            "timestamp": 1604902048
          }
        }
      }
    }

```

and the reciever (after doing all the risk checks on its side) will issue a command to transition the state as the following:

```
{
      "_ObjectType": "CommandRequestObject"
      "command_type": "ChargeCommand",
      "cid": "579a40b3-8835-4f46-bb01-532489522636",
      "command": {
        "_ObjectType": "ChargeCommand",
        "payment": {
          "reference_id": "4185027f-0574-6f55-2668-3a38fdb5de98",
          "sender": {
            "address": "dm1pg9q5zs2pg9q5zs2pg9q5zs2pg9skzctpv9skzcg9kmwta",
          },
          "receiver": {
            "address": "dm1pllhdmn9m42vcsamx24zrxgs3qqqpzg3ng32kvacapx5fl",
            "kyb_data": {
              "payload_version": 1,
              "type": "business",
              "name": "Kevin's online shop",
              "address": {
                "city": "Sunnyvale",
                "country": "US",
                "line1": "4321 Maple Street",
                "line2": "",
                "postal_code": "12345",
                "state": "California",
              },
              "category": "Retail Outlet"
            },
            "status": {
              "status": "ready_for_settlement"
            }
          }
        }
      }
    }

```

When the buyer (sender) is ready to allow this payment, the command that should be issue will look like:

```
{
      "_ObjectType": "CommandRequestObject"
      "command_type": "ChargeCommand",
      "cid": "90d6b6b7-d363-4268-a809-699586e1aa47",
      "command": {
        "_ObjectType": "ChargeCommand",
        "payment": {
          "reference_id": "4185027f-0574-6f55-2668-3a38fdb5de98",
          "sender": {
            "address": "dm1pg9q5zs2pg9q5zs2pg9q5zs2pg9skzctpv9skzcg9kmwta",
            "status": {
              "status": "ready_for_settlement"
            }
          },
          "receiver": {
            "address": "dm1pllhdmn9m42vcsamx24zrxgs3qqqpzg3ng32kvacapx5fl",
          }
        }
      }
    }

```



### CommandRequestObject
For a charge request, the [command_type](https://dip.diem.com/dip-1/#commandrequestobject) field is set to "ChargeCommand".  The command object is a [`ChargeCommand` object](#chargecommandobject).

| Field         | Type  | Required?     | Description   |
|-------        |------ |-----------    |-------------  |
| command_type   | str  | Y             | The fixed string `ChargeCommand` |
| command| [`ChargeCommandObject`](#fundpullpreapprovalobject) | Y | contains a `ChargeCommandObject` that creates a charge payment|

```
{
    "_ObjectType": "CommandRequestObject",
    "command_type": "ChargeCommand",
    "cid": "e4d39f64-9b62-4ba9-a20e-237953b01ddf",
    "command": ChargeCommandObject(),
}
```

### ChargeCommandObject

It should be noted that initial creation of the ChargeObject can be done by the VASP on either side (buyer or merchant). 


#### ___The buyer creates the initial request___
A merchant doesn't knows the buyer details upfront, so it use an out-of-band channel to request a payment (e.g. QR code). The buyer wallet (VASP) decode the request and initiate a charge flow from its side

#### ___The merchant creates the initial request___
A merchant knows the buyer details upfront. The merchant then can send an off-chain request to the buyer to request a consent. The buyer wallet (VASP) can then ask the user to approve the request





        "_ObjectType": "ChargeCommand",
        "payment": {
          "reference_id": "4185027f-0574-6f55-2668-3a38fdb5de98",
          "sender": {
            "address": "dm1pg9q5zs2pg9q5zs2pg9q5zs2pg9skzctpv9skzcg9kmwta",
            "kyc_data": {
              "payload_version": 1,
              "type": "individual",
              "given_name": "ben",
              "surname": "maurer",
              "address": {
                "city": "Sunnyvale",
                "country": "US",
                "line1": "1234 Maple Street",
                "line2": "Apartment 123",
                "postal_code": "12345",
                "state": "California",
              },
              "dob": "1920-03-20",
              "place_of_birth": {
                "city": "Sunnyvale",
                "country": "US",
                "postal_code": "12345",
                "state": "California",
              }
            },
            "status": {
              "status": "needs_kyb_data"
            },
          },
          "receiver": {
            "address": "dm1pllhdmn9m42vcsamx24zrxgs3qqqpzg3ng32kvacapx5fl",
          },
          "action": {
            "amount": 1000000000000,
            "currency": "XUS",
            "action": "charge",
            "timestamp": 1604902048
          }
        }









| Field         | Type  | Required?     | Description   |
|-------        |------ |-----------    |-------------  |
| address | str | Y | Address of account from which the pre-approval is being requested. The address is encoded using bech32 and should uniquly identify the buyer. For Diem addresses format, refer to the "account identifiers" section in [DIP-5](https://dip.diem.com/dip-5/#account-identifiers). |
| biller_address | str | Y | Address of account from which billing will happen. The address is encoded using bech32 and should uniquly identify the merchant. For Diem addresses format, refer to the "account identifiers" section in [DIP-5](https://dip.diem.com/dip-5/#account-identifiers). |
| funds_pre_approval_id | str | Y | A unique identifier of this pre-approval. Should be a UUID according to RFC4122 with "-"'s included. The same value of `cid` may be used for this field. |
| scope | [ScopeObject](#scopeobject) | Y | The scope of the agreement. This contains the expiration time and the amount limits |
| description | str | N | Description of the funds pre-approval. May be utilized to show the user description about the request for funds pre-approval |
| status | str enum | N | Status of this pre-approval. See [Pre-Approval Status Enum](#pre-approval-status-enum) for valid statuses. 

```
{
    "address": "dm1pqqgjyv6y24n80zye42aueh0wlll7ahwvhw4qpxg2y47hr",
    "biller_address": "dm1pllhdmn9m42vcsamx24zrxgs3qqqpzg3ng32kvacapx5fl",
    "funds_pre_approval_id": "88b282d6181129f682be0421d0ee9887",
    "scope": ScopeObject(),
    "description": "Kevin's online shop",
    "status": "valid",
}
```

### ScopeObject

In this object the initiator VASP declares its intent for the pre-approval.

For now, only simple type of pre-approval is supported, that is `consent`. It is used for future payments and enables the merchant VASP to charge the buyer in the buyer VASP without any human interaction.  
Also, the scope limits the FundPullPreApprovalObject to certain parameters of time and amount.


| Field         | Type  | Required?     | Description   |
|-------        |------ |-----------    |-------------  |
| type | str enum | Y | For now only `consent` is supported |
| expiration_timestamp | uint | Y | Unix timestamp indicating the time at which this pre-approval will expire - after which no funds pull can occur.  To expire an existing pre-approval early, this field can be updated with the current Unix timestamp. |
| currency | str enum | Y | One of the supported on-chain currency types - ex. XDX, etc.|
| reset | [ScopedResetObject](#scopedresetobject) | N | A defintion of a reset period of this pre-approval. When granting this agreement, one can review the periodic terms of what is the amount that can be withdrawan within a given period of time defined by this object |
| max_transaction_amount | uint | N | Max transaction amount that is approved for funds pre-approval.  This is the maximum amount that may occur in a single transaction while utilizing this funds pre-approval. Base units are the same as for on-chain transactions for this currency. For example, if DiemUSD is represented on-chain where “1” equals 1e-6 dollars, then “1” equals the same amount here.  For any currency, the on-chain mapping must be used for amounts. |

```
{
    "scope": {
        "type": "consent",
        "expiration_timestamp": 1615872312,
        "currency": "XDX",
        "reset": ScopedResetObject(),        
        "max_transaction_amount": 50000000
    }
}
```

### ScopedResetObject

This object describes the scope period for reset the cummulation of transaction amounts 

| Field         | Type       | Required?    | Description   |
|-------        |--------    |-----------   |-------------  |
| period | [PeriodObject](#periodobject) | Y | A definition of a period of time |
| amount_per_period | uint | Y | Max amount that is approved for a single period of time. This is the sum across all transactions that occur in the period. Base units are the same as for on-chain transactions for this currency. For example, if DiemUSD is represented on-chain where “1” equals 1e-6 dollars, then “1” equals the same amount here.  For any currency, the on-chain mapping must be used for amounts. |

```
{
    "reset": {
        "period": PeriodObject(),
        "amount_per_period": 1300000000,
    }
}
```

### PeriodObject

Represents a period of time. 

| Field 	    | Type 	| Required? 	| Description 	|
|-------	    |------	|-----------	|-------------	|
| unit          | str enum   | Y            | One of: "day", "week", "month", "year". This unit should be treated as a sliding time window. E.g., one week would be summary of the past 7 days transactions, no matter what weekday is it. |
| value         | int        | Y            | Number of "unit"(s)   |

```
{
    "unit": "week",
    "value": 2
}
```


### Pre Approval Status Enum
Valid values are:
* `pending` - Pending buyer user/VASP approval.
* `valid` - Approved by the user/VASP and ready for usage.
* `rejected` - User/VASP did not approve the pre-approval request.
* `closed` - Approval has been closed by the user/VASP and can no longer be used.

**Valid Status Transitions**. The status always initially begins as `pending` at which time a user must agree to the pre-approval request.  Once the user has reviewed the request, the buyer VASP will update the pre-approval status to `valid` (if the user agreed) or `rejected` (if the user rejected the pre-approval).

When `valid`, at any point, the buyer or the merchant can withdraw permission at which point the status will be updated to `closed`.


### CommandResponseObject
All responses to a CommandRequestObject are in the form of a [CommandResponseObject](basic_building_blocks.md#commandresponseobject)

## Usage of a pre-approval
Pre-approval usage manifests as an extension of [PaymentCommand](https://dip.diem.com/dip-1/#paymentcommand-object).  The extension happens primarily within the [PaymentObject](https://dip.diem.com/dip-1/#paymentobject) as seen below.

### PaymentObject Extension
Payment object remains the same as [PaymentObject](https://dip.diem.com/dip-1/#paymentobject), but adds the following fields:

| Field         | Type  | Required?     | Description   |
|-------        |------ |-----------    |-------------  |
| funds_pre_approval_id | str | N | ID of the funds pre-approval previously created via a [FundPullPreApprovalCommand](#fundpullpreapprovalcommand-object).  Must match the value of "funds_pre_approval_id" in the already-created funds pre-approval.

---

# Auth/Capture
### *VERSION SUPPORT: Supported only in version 3 of off-chain APIs*

Authorization allows the placing of holds on funds with the assurance that an amount up to the held amount can be captured at a later time.  An example of this is for delayed fulfillment or pre-authorizing an expected amount to ensure that an amount can be charged after services are rendered.

When an authorization happens, the sender VASP (buyer) who agrees to the authorization request must lock the funds for the specified period. That is - the buyer VASP guarantees that the funds will be available if later captured.

Auth/capture is an extension of [PaymentCommand](https://dip.diem.com/dip-1/#paymentcommand-object).  The extension happens primarily within the [PaymentActionObject](https://dip.diem.com/dip-1/#paymentactionobject) and the status changes within the [PaymentActor](https://dip.diem.com/dip-1/#paymentactorobject).

Authorization is granted by the consumer/buyer VASP and can only be revoked by the merchant. Authorizations are expected to have a shorter expiration time than Fund Pull Pre-Approvals as they serve for a single payment.

### PaymentActionObject Extension

The [PaymentActionObject](https://dip.diem.com/dip-1/#paymentactionobject) now becomes:

| Field 	    | Type 	| Required? 	| Description 	|
|-------	    |------	|-----------	|-------------	|
| amount | uint | Y | Amount of the transfer.  Base units are the same as for on-chain transactions for this currency.  For example, if DiemUSD is represented on-chain where “1” equals 1e-6 dollars, then “1” equals the same amount here.  For any currency, the on-chain mapping must be used for amounts. |
| currency | enum | Y | One of the supported on-chain currency types - ex. XDX, etc. |
| action | enum | Y | Populated in the request.  This value indicates the requested action to perform. For a normal transfer, "charge" is still used.  For auth and capture, "auth" and "capture" are now available.  "capture" can only be performed after a valid "auth" |
| valid_until | uint | N | Unix timestamp indicating the time period for which this authorization is valid.  Once this time has been reached, the authorization is no longer able to be captured and funds should be unlocked. |
| timestamp | uint | Y | Unix timestamp indicating the time that the payment Command was created.

```
{
    "amount": 100,
    "currency": "XDX",
    "action": "auth",
    "valid_until": 74000,
    "timestamp": 72322,
}
```

### StatusEnum

The auth/capture flow now adds the following to the status enum of [PaymentActor](https://dip.diem.com/dip-1/#paymentactorobject):

* `authorized` - The payment amount is authorized but not yet captured.

`abort` may still be used to cancel the authorization early.  Once a capture action occurs, the status of the payment will now be updated to `ready_for_settlement`.

**Valid Status Transitions**. `authorized` is now a valid initial value and may be followed by `ready_for_settlement` (upon a successful capture) or `abort` (if a valid cancel request was sent).

## Cancellation

This LIP describes two independent phases of a payment - pre-approval and auth/capture.

The first one (pre-approval) may be canceled by either side (buyer or seller). A reasonable scenario is when a consumer wishes to cancel a subscription (buyer cancel) or asks a merchant app to remove the user wallet from the list of payment methods (seller cancel). 

The second (authorization) could be canceled only by the biller (merchant) as it holds a guarantee of funds availability if requested. This has no reason to be canceled by the buyer. A request for such cancellation from the buyer should be rejected. 
